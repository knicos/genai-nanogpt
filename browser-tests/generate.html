<html>
    <head>
        <title>TM Language Model</title>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgpu/dist/tf-backend-webgpu.min.js"></script>
        <script
            type="module"
            src="../dist/ops/webgpu/index.js"
        ></script>
        <script
            type="module"
            src="/dist/main.js"
        ></script>
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #webcam {
                margin-bottom: 20px;
            }
            #prediction {
                font-size: 24px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import { TeachableLLM, waitForModel, selectBackend } from '/dist/main.js';

            await selectBackend('webgpu');

            const fileInput = document.getElementById('fileInput');
            const generateButton = document.getElementById('generateButton');
            const stepButton = document.getElementById('stepButton');
            const output = document.getElementById('output');
            let model = null;
            let generator = null;
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    model = await TeachableLLM.loadModel(file);
                    await waitForModel(model);
                    model.enableProfiler = true;
                    generator = model.generator();
                }
            });

            generateButton.addEventListener('click', async () => {
                if (!model || !generator) {
                    alert('Please load a model first.');
                    return;
                }
                const prompt = 'Once upon a time';
                console.log('Generating text for prompt:', prompt);
                const options = {
                    maxLength: 128 * 4 * 2,
                    temperature: 0.7,
                    attentionScores: false,
                    topP: 0.8,
                };
                const generated = await generator.generate(prompt, options);
                output.innerText = '\n\nGenerated Text:\n' + generated;
                console.log('Attention', options.attentionScores);
                model.getProfiler().printSummary();
            });

            stepButton.addEventListener('click', async () => {
                if (!model || !generator) {
                    alert('Please load a model first.');
                    return;
                }
                const innerText = output.innerText;
                const prompt = 'Once upon a time';
                console.log('Step generating text for prompt:', prompt);
                const options = {
                    maxLength: 128 * 4 * 2,
                    temperature: 0.7,
                    attentionScores: false,
                    topP: 0.8,
                };

                const stepGen = await generator.step(prompt, options);

                console.log('Step Generated Text:', stepGen);

                output.innerText = stepGen;

                model.getProfiler().printSummary();
            });
        </script>
        <input
            type="file"
            id="fileInput"
            accept=".zip"
        />
        <button id="generateButton">Generate Text</button>
        <button id="stepButton">Step Generate</button>
        <div id="output"></div>
    </body>
</html>
