<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>EfficientScatterSub WebGL Test</title>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
        <script
            type="module"
            src="../dist/ops/scatterSub.js"
        ></script>
    </head>
    <body>
        <script type="module">
            async function cpuVersion() {
                await tf.setBackend('cpu');
                const logits = tf.tensor2d([
                    [0.1, 0.2, 0.7],
                    [0.3, 0.4, 0.3],
                ]);
                const labels = tf.tensor1d([2, 0], 'int32');
                const softmaxProbs = tf.softmax(logits);
                const dy = tf.tensor1d([1.0, 1.0]);

                // Custom op
                const custom = tf.engine().runKernel('EfficientScatterSub', { logits: softmaxProbs, labels, dy }, {});
                const customArr = await custom.array();
                return customArr;
            }

            async function gpuVersion() {
                await tf.setBackend('webgl');
                const logits = tf.tensor2d([
                    [0.1, 0.2, 0.7],
                    [0.3, 0.4, 0.3],
                ]);
                const labels = tf.tensor1d([2, 0], 'int32');
                const softmaxProbs = tf.softmax(logits);
                const dy = tf.tensor1d([1.0, 1.0]);

                // Custom op
                const custom = tf.engine().runKernel('EfficientScatterSub', { logits: softmaxProbs, labels, dy }, {});
                const customArr = await custom.array();
                return customArr;
            }

            async function runTest() {
                const customArr = await gpuVersion();
                const manualArr = await cpuVersion();

                // Compare arrays
                const match = JSON.stringify(manualArr) === JSON.stringify(customArr);
                document.body.innerText = match ? 'PASS' : 'FAIL';
                window.testResult = { match, manualArr, customArr };
            }
            runTest();
        </script>
    </body>
</html>
